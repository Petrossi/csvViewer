<html layout:decorator="core/layout" xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml">
    <div layout:fragment="header_sources">
        <link rel="stylesheet" media="screen" href="http://www.convertcsv.com/js/grid/jquery.handsontable.full.css"/>
        <script src="http://www.convertcsv.com/js/grid/jquery.handsontable.full.js"></script>
        <style>
            .table-wrapper {
                /*margin-top: 75px;*/
            }

            .buttons-wrapper {
                display: flex;
                margin-top: 25px;
            }

            .pagination-info-wrapper {
                display: flex;
                justify-content: space-between;
                margin-bottom: 25px;
            }

            .buttons-wrapper button {
                flex: 1;
            }
        </style>
    </div>

    <div layout:fragment="content">
        <div class="row">
            <div class="col-md-12 col-md-offset-0 table-wrapper" >
                <div id="divSpinner"></div>

                <div class="pagination-info-wrapper" id="paginationInfo" style="display: none">
                    <p id="requestInfo"></p>
                    <div></div>
                    <select id="pageSizeSelect"></select>
                </div>
                <div id="taskData">
                    <div id="dataTable" style="overflow: auto; vertical-align: top;" class="handsontable"></div>
                </div>

                <div class="buttons-wrapper" id="paginationButtons"></div>
            </div>
        </div>
    </div>
    <div layout:fragment="body_sources">
        <script th:src="@{/static/javascripts/csvparse.js}"></script>
        <script src="http://www.convertcsv.com/json2.js"></script>
        <script src="http://www.convertcsv.com/js/blob.js"></script>
        <script src="http://www.convertcsv.com/js/filesaver.js"></script>
        <script src="http://www.convertcsv.com/js/storagesup.js"></script>
        <script th:src="@{/static/javascripts/utils.js}"></script>
        <script th:src="@{/static/javascripts/main.js}"></script>
        <script th:inline="javascript">

            var token = [[${task.token}]];

            let paginationInfo = {
                pageSize: 100,
                page: 1,
                token: token,
            };

            const headers = [[${task.headers}]];
            const columns = headers.map((columnName) => {return {data: columnName}});

            $( document ).ready(function () {
                rendesSizesSelect();
                init()
            });

            function showSpinner() {
                $('#divSpinner').show();
                $('#paginationInfo').hide();
                // $('#taskData').hide();
                spinit.spin(document.getElementById('divSpinner'));
            }

            function hideSpinner() {
                $('#divSpinner').hide();
                $('#paginationInfo').show();
                // $('#taskData').show();
                spinit.stop(document.getElementById('divSpinner'));
            }

            function init() {
                showSpinner();
                // return
                const path = "/task/data/pagination/" + objectToQuerystring(paginationInfo);
                $.get(path , (response) => {
                    processCsv(response);
                })
            }
            function updatePaginationInfo(newPaginationInfoData) {
                paginationInfo = Object.assign(paginationInfo, newPaginationInfoData);
                console.log(newPaginationInfoData, paginationInfo)
                init()
            }

            function processCsv(data) {
                _.delay(() => {
                    showGrid(data);
                    hideSpinner();

                    renderPaginationInfo(data);
                    renderPaginationButtons(data);
                }, 300);
            }

            function rendesSizesSelect(){
                const sizes = [10, 50, 100, 250, 500];
                const sizesHtml = sizes.map(size => {
                    const selected = paginationInfo.pageSize === size;

                    return `<option data-pageSize="${size}" ${selected ? "selected" : ""}>show ${size} entries</option>`;
                }).join("");
                $('#pageSizeSelect').html(sizesHtml);
                $('#pageSizeSelect').change(function () {
                    updatePaginationInfo({pageSize: $(this).find(':selected').data("pagesize")});
                });
            }

            function renderPaginationInfo(data){
                $('#requestInfo').text(`Showing ${(paginationInfo.page - 1 ) * paginationInfo.pageSize} to ${(paginationInfo.page ) * paginationInfo.pageSize} of ${data.totalCount}`);
            }

            function renderPaginationButtons(data){
                $('#paginationButtons').html(`
                    <button class="btn btn-warning paginationButton" data-page="1">first</button>
                    <button class="btn btn-primary paginationButton" ${paginationInfo.page - 1 <= 0 ? 'disabled' : 'data-page=' + (paginationInfo.page -1)}>${paginationInfo.page - 1}</button>
                    <button class="btn btn-success paginationButton" disabled>${paginationInfo.page}</button>
                    <button class="btn btn-primary paginationButton" ${paginationInfo.page + 1 > data.pages ? 'disabled' : "data-page=" + (paginationInfo.page + 1)}>${paginationInfo.page + 1}</button>
                    <button class="btn btn-warning paginationButton" data-page="${paginationInfo.page}">last</button>
                `);

                $(".paginationButton").click(function (){
                    updatePaginationInfo($(this).data());
                })
            }

            function showGrid(data) {
                const dataTable = $("#dataTable");
                dataTable.handsontable({
                    data: data.summary,
                    colHeaders: headers,
                    columns: columns,
                    rowHeaders: true,
                    scrollH: 'auto',
                    scrollV: 'auto',
                    autoWrapRow: false,
                    stretchH: 'all',
                    height: 800
                });
                dataTable.handsontable("selectCell", 0, 0);
                dataTable.handsontable("render");
            }
        </script>
    </div>
</html>